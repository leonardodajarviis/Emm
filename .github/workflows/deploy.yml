name: Deploy ASP.NET to VPS

on:
  push:
    branches: ["main"] # Cháº¡y khi cÃ³ code Ä‘áº©y vÃ o nhÃ¡nh main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      # 1. Láº¥y code vá»
      - name: Checkout code
        uses: actions/checkout@v4

      # 2. ÄÄƒng nháº­p Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 3. Build vÃ  Ä‘áº©y Image lÃªn Docker Hub
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/aspnet-emm-app:latest

      # 4. SSH vÃ o VPS Ä‘á»ƒ cháº¡y container má»›i vá»›i zero-downtime deployment
      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e  # Exit immediately if any command fails

            echo "ðŸ”„ Starting deployment..."

            # Pull image má»›i nháº¥t vá» trÆ°á»›c
            echo "ðŸ“¥ Pulling latest image..."
            if ! docker pull ${{ secrets.DOCKER_USERNAME }}/aspnet-emm-app:latest; then
              echo "âŒ Failed to pull Docker image"
              exit 1
            fi

            # Backup tÃªn container cÅ© Ä‘á»ƒ rollback náº¿u cáº§n
            OLD_CONTAINER="aspnet-emm-app-container"
            NEW_CONTAINER="aspnet-emm-app-container-new"
            BACKUP_CONTAINER="aspnet-emm-app-container-backup"

            # Náº¿u cÃ³ container cÅ© Ä‘ang cháº¡y, rename nÃ³ thÃ nh backup
            if docker ps -a --format '{{.Names}}' | grep -q "^${OLD_CONTAINER}$"; then
              echo "ðŸ“¦ Backing up old container..."
              docker rename ${OLD_CONTAINER} ${BACKUP_CONTAINER} 2>/dev/null || true
            fi

            # Cháº¡y container má»›i vá»›i tÃªn táº¡m
            echo "ðŸš€ Starting new container..."
            docker run -d \
              --name ${NEW_CONTAINER} \
              --restart always \
              -p 2310:2310 \
              -e ASPNETCORE_ENVIRONMENT=Production \
              -e ConnectionStrings__DefaultConnection="${{ secrets.DB_CONNECTION_STRING }}" \
              -e Jwt__AccessKey="${{ secrets.JWT_ACCESS_KEY }}" \
              -e Jwt__RefreshKey="${{ secrets.JWT_REFRESH_KEY }}" \
              -e StmpEmail__Username="${{ secrets.SMTP_USERNAME }}" \
              -e StmpEmail__Password="${{ secrets.SMTP_PASSWORD }}" \
              ${{ secrets.DOCKER_USERNAME }}/aspnet-emm-app:latest

            # Äá»£i container khá»Ÿi Ä‘á»™ng
            echo "â³ Waiting for container to start..."
            sleep 5

            # Kiá»ƒm tra container cÃ³ cháº¡y khÃ´ng
            if ! docker ps | grep -q ${NEW_CONTAINER}; then
              echo "âŒ New container failed to start!"
              echo "ðŸ“‹ Container logs:"
              docker logs ${NEW_CONTAINER}

              # Rollback: XÃ³a container má»›i vÃ  khÃ´i phá»¥c container cÅ©
              echo "ðŸ”„ Rolling back to previous version..."
              docker rm -f ${NEW_CONTAINER} 2>/dev/null || true

              if docker ps -a --format '{{.Names}}' | grep -q "^${BACKUP_CONTAINER}$"; then
                docker rename ${BACKUP_CONTAINER} ${OLD_CONTAINER}
                docker start ${OLD_CONTAINER}
                echo "âœ… Rolled back to previous version successfully"
              fi

              exit 1
            fi

            # Health check: Kiá»ƒm tra API cÃ³ respond khÃ´ng (optional - cáº§n health endpoint)
            echo "ðŸ¥ Performing health check..."
            sleep 3
            if ! curl -f http://localhost:2310/health 2>/dev/null; then
              echo "âš ï¸  Warning: Health check failed, but container is running"
              echo "ðŸ“‹ Recent logs:"
              docker logs --tail 50 ${NEW_CONTAINER}
              # KhÃ´ng exit Ä‘á»ƒ cho phÃ©p deploy tiáº¿p náº¿u chá»‰ health endpoint chÆ°a cÃ³
            fi

            # Deployment thÃ nh cÃ´ng - dá»n dáº¹p
            echo "ðŸ§¹ Cleaning up..."

            # Rename container má»›i thÃ nh tÃªn chÃ­nh thá»©c
            docker rename ${NEW_CONTAINER} ${OLD_CONTAINER}

            # Dá»«ng vÃ  xÃ³a container backup cÅ©
            if docker ps -a --format '{{.Names}}' | grep -q "^${BACKUP_CONTAINER}$"; then
              docker stop ${BACKUP_CONTAINER} 2>/dev/null || true
              docker rm ${BACKUP_CONTAINER} 2>/dev/null || true
            fi

            # XÃ³a cÃ¡c image khÃ´ng dÃ¹ng Ä‘á»ƒ tiáº¿t kiá»‡m dung lÆ°á»£ng
            docker image prune -af --filter "until=24h"

            echo "âœ… Deployment successful!"
            echo "ðŸ“Š Container status:"
            docker ps --filter "name=${OLD_CONTAINER}" --format "table {{.Names}}\t{{.Status}}\t{{.Ports}}"
