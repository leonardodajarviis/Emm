name: Deploy ASP.NET to VPS

on:
  push:
    branches: ["main"]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/aspnet-emm-app:latest

      - name: Deploy to VPS
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          key: ${{ secrets.VPS_SSH_KEY }}
          script: |
            set -e # D·ª´ng ngay n·∫øu c√≥ l·ªói

            # --- C·∫§U H√åNH ---
            CONTAINER_NAME="aspnet-emm-app-container"
            IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/aspnet-emm-app:latest"

            echo "üöÄ B·∫Øt ƒë·∫ßu Deploy..."

            # 1. Pull image m·ªõi nh·∫•t v·ªÅ
            echo "üì• ƒêang k√©o Image m·ªõi nh·∫•t..."
            docker pull $IMAGE_NAME

            # 2. Stop v√† Remove container c≈© (Kh·∫Øc ph·ª•c l·ªói port allocated)
            # D√πng '|| true' ƒë·ªÉ kh√¥ng b√°o l·ªói n·∫øu container ch∆∞a t·ªìn t·∫°i (l·∫ßn ƒë·∫ßu deploy)
            echo "üõë ƒêang d·ª´ng container c≈©..."
            docker stop $CONTAINER_NAME || true

            echo "üóëÔ∏è ƒêang x√≥a container c≈©..."
            docker rm $CONTAINER_NAME || true

            # 3. Ch·∫°y container m·ªõi
            echo "üî• ƒêang kh·ªüi ch·∫°y container m·ªõi..."
            docker run -d \
              --name $CONTAINER_NAME \
              --restart always \
              -p 2310:2310 \
              -e ASPNETCORE_ENVIRONMENT=Production \
              -e ConnectionStrings__DefaultConnection="${{ secrets.DB_CONNECTION_STRING }}" \
              -e Jwt__AccessKey="${{ secrets.JWT_ACCESS_KEY }}" \
              -e Jwt__RefreshKey="${{ secrets.JWT_REFRESH_KEY }}" \
              -e StmpEmail__Username="${{ secrets.SMTP_USERNAME }}" \
              -e StmpEmail__Password="${{ secrets.SMTP_PASSWORD }}" \
              $IMAGE_NAME

            # 4. Ki·ªÉm tra xem container c√≥ s·ªëng kh√¥ng
            echo "‚è≥ ƒêang ki·ªÉm tra tr·∫°ng th√°i..."
            sleep 5
            if [ "$(docker ps -q -f name=$CONTAINER_NAME)" ]; then
              echo "‚úÖ Container ƒëang ch·∫°y ·ªïn ƒë·ªãnh!"
              docker ps -f name=$CONTAINER_NAME
            else
              echo "‚ùå Container kh√¥ng ch·∫°y! Ki·ªÉm tra logs:"
              docker logs $CONTAINER_NAME
              exit 1
            fi

            # 5. D·ªçn d·∫πp r√°c (Image c≈©) ƒë·ªÉ kh√¥ng ƒë·∫ßy ·ªï c·ª©ng VPS
            echo "üßπ D·ªçn d·∫πp h·ªá th·ªëng..."
            docker image prune -af --filter "until=24h"

            echo "üéâ Deploy ho√†n t·∫•t!"
